{% load static %}

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <!-- MDB -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.10.1/mdb.min.css" rel="stylesheet" />
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/4.0.0/mdb.min.js"></script>
    <!-- jquery -->
    <!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> -->
    <!-- customcss -->
    <link rel="stylesheet" href="{% static 'common/css/style.css' %}" />
    <link rel="stylesheet" href="{% static 'app/css/style.css' %}" />
    <!-- customjs -->
    <script type="text/javascript" src="{% static 'app/js/script.js' %}"></script>
    <title>app_base</title>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="/">ホーム</a>
          </li>
          {% if user.is_authenticated %}
          <li class="nav-item">
            <a class="nav-link" href="{% url 'profile' user.id %}">マイページ</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'account_logout' %}">ログアウト</a>
          </li>
          {% else %}
          <li class="nav-item">
            <a class="nav-link" href="{% url 'account_signup' %}">新規登録</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'account_login' %}">ログイン</a>
          </li>
          {% endif %}
        </ul>
        <ul class="navbar-nav ml-auto">
          {% if user.is_authenticated %}
          <li class="nav-item align-content-start">
            <a class="nav-link" href="{% url 'tweet_create' %}">投稿</a>
          </li>
          {% endif %}
        </ul>
      </div>
    </nav>

    <main>
      <div class="container">{% block content %} {% endblock %}</div>
    </main>

    <footer class="py-2 bg-dark footer">
      <p class="m-0 text-center text-white">
        Copyright &copy; Shota Isoda 2022
      </p>
    </footer>
  </body>
</html>


<!-- js -->
<!-- {% block extrajs %}
<script>

function addLikeButtonEvent(button) {
    // likeボタンが押下されたら実行
    button.addEventListener('click', e => {
        // もしログインしていなかったらログイン画面に遷移
        const is_authenticated = button.getAttribute('data-is-authenticated');
        const account_login = button.getAttribute('data-account-login');
        if (is_authenticated === "False") {
            window.location.href = account_login;
        }
        // イベントのデフォルトの動作をキャンセル
        e.preventDefault();
        // 各種変数に代入
        const tweetPk = button.getAttribute('data-tweet-pk');
        const url = button.getAttribute('data-tweet-like-tweet-url');
        const csrf_token = button.getAttribute('data-csrf-token');
        const formData = new FormData();
        formData.append('tweet_pk', tweetPk);
        // fetchAPIでPOST送信
        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {'X-CSRFToken': csrf_token}
        }).then(response => {
            return response.json();
        }).then(response => {
            const counter = button.nextElementSibling;
            const icon = button.querySelector('.like-for-post-icon');
            counter.textContent = response.tweet_likes;
            if (response.method === 'create') {
                icon.classList.remove('far');
                icon.classList.add('fas');
            } else {
                icon.classList.remove('fas');
                icon.classList.add('far');
            }
        }).catch(error => {
            console.log(error);
        });
    });
}

document.querySelectorAll('.ajax-like-for-post').forEach(button => {
  addLikeButtonEvent(button);
});

// 無限スクロール
var isLoading = false;

function loadMoreTweets() {
    if (!isLoading) {
        isLoading = true;
        var tweetContainer = document.querySelector('.tweet-container');
        var nextPage = tweetContainer.getAttribute('data-next-page');

        if (nextPage !== null) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', window.location.pathname + '?page=' + nextPage, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                    var parser = new DOMParser();
                    var data = parser.parseFromString(xhr.responseText, 'text/html');
                    var newTweetsContainer = data.querySelector('.tweet-container');
                    var newTweets = newTweetsContainer.innerHTML;
                    tweetContainer.insertAdjacentHTML('beforeend', newTweets);
                    tweetContainer.setAttribute('data-next-page', newTweetsContainer.getAttribute('data-next-page'));
                    isLoading = false;

                    // 新しいツイートに対していいねボタンのイベントリスナーを再設定
                    document.querySelectorAll('.ajax-like-for-post').forEach(button => {
                        addLikeButtonEvent(button);
                    });
                } else if (xhr.readyState === XMLHttpRequest.DONE) {
                    isLoading = false;
                }
            };
            xhr.send();
        }
    }
}

function handleScroll() {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 300) {
        loadMoreTweets();
    }
}

window.addEventListener('scroll', handleScroll);
</script>
{% endblock %} -->